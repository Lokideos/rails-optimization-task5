# Оптимизация загрузки ассетов

## Актуальная проблема

На данный момент скорость загрузки сайта на различных мобильных устройствах, особенно при
использовании 3G, не велика.

## Формирование метрики

В качестве метрики было выбрано время рендеринга главной страницы. Для формирования метрики был
использован инструмент `sitespeed.io`.

## Гарантия работы оптимизированной программы

Для гарантии работы оптимизированной программы были использованы уже существующие в приложении
тесты, написанные с помощью библиотеки `rspec`.

## Feedback-Loop

Для эффективной оптимизации был выстроен следующий `feedback-loop`: Профилирование с использованием
`sitespeed.io` -> Оптимизация -> Проверка работы программы с использованием тестов.

## Анализ ассимптотики

Для анализа ассимптотики была использована утилита `sitespeed.io`. С ее помощью была выяснена
скорость рендеринга страницы для мобильных устройств командой `docker run --rm -v "$(pwd)": /sitespeed.io sitespeedio/sitespeed.io --mobile -n 5 --preUrl https://host.docker.internal/ https://host.docker.internal/`

## Анализ точек роста

### Имплементация HTTP/2

Для оптимизации рендеринга страницы было решено первести приложение на работу с HTTP/2 и доставлять
ряд ассетов на клиент с помощью технологии `server_push`. Для этого было необходимо предварительно
подключить HTTPS. Для его работы на локальную машину был установлен NGINX, были сгенерированы
self-signed certificates с помощью утилиты `mkcert` и с помощью них NGINX был настроен на работу с
HTTPS (было настроено проксирование на локально поднятый сервер). На самом сервере https был вклчен
в `application.rb` с помощью настройки `config.force_ssl = true`. Следующие ассеты стали
доставляться с помощью `server_push`: bell.svg, menu.svg, connect.svg, stack.svg, lightning.svg. В
среднем ранее они загружались 150мс, а после подключения HTTP/2 стали загружаться в среднем 1мс.
Утилита `sitespeed.io` также показала, что перевод доставки ассетов на server_push сильно ускорил
время их появления на странице.

### Результаты

В результате оптимизации гораздо быстрее стали прогружаться ряд ассетов, переведенных на
`server_push`.
